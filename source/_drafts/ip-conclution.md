---
title: ip-conclution
mathjax: false
tags: ip
categories: 网络
---

## 序

IP相关内容整理

## 概述

网络层的主要任务是**实现网络互联**，进而**实现数据包在各网络之间的传输**

1. 网络层像运输层提供怎样的服务（可靠、不可靠）
2. 网络寻址问题/转发
3. 路由选择问题



## 两种服务

### 面向链接的虚电路服务

类似电话

### 无链接的数据报服务

<img src="https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210620212429818.png" alt="无链接的数据服务" style="zoom:33%;" />

## IPV4

因为32位不方便阅读，所以使用采用点分十进制表示方法以方便用户的使用。每8位表示一个10进制

### 分类编址

![IP分类](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210530183834044.png)

#### **五类互联网地址：**

 IP地址根据网络号和主机号来分，分为A、B、C三类及特殊地址D、E。 全0和全1的都保留不用。

1. A类：(1.0.0.0-126.0.0.0)（默认子网掩码：255.0.0.0或 0xFF000000）第一个字节为网络号，后三个字节为主机号。该类IP地址的最前面为“0”，所以地址的网络号取值于1~126之间。一般用于大型网络。
2. B类：(128.0.0.0-191.255.0.0)（默认子网掩码：255.255.0.0或0xFFFF0000）前两个字节为网络号，后两个字节为主机号。该类IP地址的最前面为“10”，所以地址的网络号取值于128~191之间。一般用于中等规模网络。
3. C类：(192.0.0.0-223.255.255.0)（子网掩码：255.255.255.0或 0xFFFFFF00）前三个字节为网络号，最后一个字节为主机号。该类IP地址的最前面为“110”，所以地址的网络号取值于192~223之间。一般用于小型网络。
4. D类：是多播地址。该类IP地址的最前面为“1110”，所以地址的网络号取值于224~239之间。一般用于多路广播用户 。
5. E类：是保留地址。该类IP地址的最前面为“1111”，所以地址的网络号取值于240~255之间。

#### 一些细节：



### 划分子网

为什么会出现划分子网的需求：

==子网掩码可以表明分类IP地址的主机号部分被借用了几个比特位作为子网号码==

![image-20210620225215662](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210620225215662.png)



![image-20210620225955254](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210620225955254.png)



#### 一些细节：

### 无分类编址

1. 划分子网在一定的程度上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网络因为其他地址空间太小并没有得到充分的使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面临全部耗尽的威胁

消除了传统的A、B、C类地址，以及划分子网的概念。使用斜线记法  譬如 128.14.35.7/20 表示前 20 位为网络前缀。通过无分类编址，能够直接获取很多信息：最小地址，最大地址，地址数量等

![例子](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210620231542523.png)

##### 路由聚合：



#### 一些细节：



### IPv4分组格式

![IPv4数据包格式](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210621164730048.png)

1. 版本

   采用的是什么版本，一般为IPv4

2. 首部长度

   占4位。常用的首部长度为20字节

3. 总长度

   首部和数据部分之和的长度，单位字节。数据报的最大长度为$2^{16} - 1 = 65535$ 同时以太网帧的最大传输单元为MTU = 1500，所以需要对数据报进行分片。也就引入了如下的标识、标志、片偏移字段

4. 标识

   计数器，每产生一个数据报就+1，并赋值给标识字段。主要是为了数据报分片之后，能够正确重装为原来的数据报

5. 标志

   最低位为MF，MF=1表示后面还有分片，MF=0表示为最后一个分片

6. 片偏移

   表示在分片之后，当前的数据报在原分组的相对位置

7. 协议

   使用的传输层协议

8. 源地址

9. 目的地址

10. 数据部分

### IP数据分片：

链路层数据报承载的最大量称为**最大传送单元（MTU）**， 因为IP数据报被封装在链路层数据报中，所以链路层的MTU限制了IP数据报的长度。

![image-20210621171305531](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210621171305531.png)

### 分发过程

1. 路由器根据目标主机的IP地址D获取网络地址N（通过子网掩码）
2. 如果网络N和路由器直接相连，把数据报直接交付给目的主机D
3. 如果不直接相连，如果有路由表中有目的地址为D的指定路由器，直接把数据报交给指定的下一跳路由
4. 如果不直接相连，且路由表中没有特定指定的路由器，但是路由表中有到达网络N的路由，将数据发送给下一跳路由
5. 如果路由表不存在网络地址为N的路由，法共给默认的路由。



### IPV4 和NET

专用网内部的主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。

在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多只可以同时有 n 台主机接入互联网。为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把传输层的端口号也用上了，使得多个专用网内部的主机共用一个全球 IP 地址。使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。

![image-20210621173321835](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20210621173321835.png)



## ICMP

为了提高IP数据报交付成功的机会，使用ICMP来允许主机或路由器报告操作和异常情况。

1. ICMP差错报告报文
2. ICMP询问报文

#### 常见应用

1. ping
   1. 检测两个主机之间的连通性
   2. 使用了ICMP回送请求和回答报文
   3. PING工作在应用层，直接使用了网络层的ICMP协议，没有使用到传输层的TCP/UDP协议
2. traceroute
   1. 各种分组经过的路由
   2. 使用了ICMP时间超过报文
   3. traceroute工作在网络层





